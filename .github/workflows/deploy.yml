name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version: '1.21'

    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸš€ Starting deployment..."
          APP_DIR="/app/roproxy-lite"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          if [ ! -d ".git" ]; then
            git clone https://github.com/Helloa123y/roproxy-lite.git .
          else
            git pull origin main
          fi
          
          go mod download
          go build -o roproxy-lite
          
          # Systemd service ohne EOF - Einzeiler
          echo -e "[Unit]\nDescription=RoProxy Lite Service\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nWorkingDirectory=$APP_DIR\nExecStart=$APP_DIR/roproxy-lite\nEnvironment=TIMEOUT=10\nEnvironment=RETRIES=3\nEnvironment=PORT=8080\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target" > /etc/systemd/system/roproxy-lite.service
          
          systemctl daemon-reload
          systemctl enable roproxy-lite
          systemctl restart roproxy-lite
          echo "âœ… Deployment completed!"
