name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version: '1.21'

    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # App directory
          APP_DIR="/app/roproxy-lite"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          # Kill old processes first! - MIT || true IGNORIEREN
          echo "ğŸ”« Killing old processes..."
          pkill -f roproxy-lite || echo "âš ï¸ No processes to kill (this is normal)"
          sleep 2
          
          # Clean directory
          echo "ğŸ§¹ Cleaning directory..."
          rm -rf ./* ./.git* 2>/dev/null || true
          
          # Download repository
          echo "ğŸ“¦ Downloading repository..."
          wget https://github.com/Helloa123y/roproxy-lite/archive/refs/heads/main.tar.gz -O repo.tar.gz || echo "âš ï¸ Download failed, trying git..."
          git clone https://github.com/Helloa123y/roproxy-lite.git . --depth=1 || echo "âŒ Git clone also failed"
          
          # DEBUG
          echo "ğŸ“ Files in directory:"
          ls -la
          echo "ğŸ“„ main.go content (first 10 lines):"
          head -10 main.go || echo "No main.go found"
          
          # Build application
          echo "ğŸ”¨ Building..."
          go mod download || echo "âš ï¸ go mod download failed"
          go build -v -o roproxy-lite || echo "âŒ Build failed"
          
          echo "ğŸ” Build result:"
          ls -la roproxy-lite || echo "âŒ Binary not found"
          
          # Test the binary manually
          echo "ğŸ§ª Testing binary manually..."
          export TIMEOUT=10
          export RETRIES=3
          export PORT=8080
          timeout 5s ./roproxy-lite || echo "âš ï¸ Binary test completed (may have started)"
          
          # Create systemd service
          echo "ğŸ“‹ Creating service..."
          echo "[Unit]" > /etc/systemd/system/roproxy-lite.service
          echo "Description=RoProxy Lite Service" >> /etc/systemd/system/roproxy-lite.service
          echo "After=network.target" >> /etc/systemd/system/roproxy-lite.service
          echo "" >> /etc/systemd/system/roproxy-lite.service
          echo "[Service]" >> /etc/systemd/system/roproxy-lite.service
          echo "Type=simple" >> /etc/systemd/system/roproxy-lite.service
          echo "User=root" >> /etc/systemd/system/roproxy-lite.service
          echo "WorkingDirectory=$APP_DIR" >> /etc/systemd/system/roproxy-lite.service
          echo "ExecStart=$APP_DIR/roproxy-lite" >> /etc/systemd/system/roproxy-lite.service
          echo "Environment=TIMEOUT=10" >> /etc/systemd/system/roproxy-lite.service
          echo "Environment=RETRIES=3" >> /etc/systemd/system/roproxy-lite.service
          echo "Environment=PORT=8080" >> /etc/systemd/system/roproxy-lite.service
          echo "Restart=always" >> /etc/systemd/system/roproxy-lite.service
          echo "RestartSec=5" >> /etc/systemd/system/roproxy-lite.service
          echo "" >> /etc/systemd/system/roproxy-lite.service
          echo "[Install]" >> /etc/systemd/system/roproxy-lite.service
          echo "WantedBy=multi-user.target" >> /etc/systemd/system/roproxy-lite.service
          
          # Stop and disable old service first
          echo "ğŸ›‘ Stopping old service..."
          systemctl stop roproxy-lite || echo "âš ï¸ Service not running"
          systemctl disable roproxy-lite || echo "âš ï¸ Service not enabled"
          
          systemctl daemon-reload
          systemctl enable roproxy-lite
          systemctl start roproxy-lite
          
          echo "âœ… Deployment completed!"
          sleep 5
          systemctl status roproxy-lite --no-pager
          
          # SHOW LOGS TO SEE WHY IT FAILS
          echo "ğŸ“‹ Service logs:"
          journalctl -u roproxy-lite -n 20 --no-pager
          
          echo "ğŸ” Checking processes:"
          ps aux | grep roproxy || echo "No processes found"
          
          echo "ğŸ” Checking port 8080:"
          netstat -tlnp | grep :8080 || echo "Port 8080 not found"
          
          echo "ğŸ§ª Final test with curl:"
          curl -s http://localhost:8080 || echo "Curl failed"
